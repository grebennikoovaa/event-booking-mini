{% extends "base.html" %}
{% block title %}{{ event.title }} ¬∑ Event Booking{% endblock %}

{% block content %}
<div class="mb-3">
  <a class="text-decoration-none" href="{% url 'event_list' %}">‚Üê Back to events</a>
</div>


<div class="card shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
      <div>
        <h1 class="h3 mb-1">{{ event.title }}</h1>
        <div class="text-secondary small">üìÖ {{ event.start_datetime }}</div>
        {% if event.location %}
          <div class="text-secondary small">üìç {{ event.location }}</div>
        {% endif %}
      </div>
      <span class="badge text-bg-primary">Event</span>
    </div>

    {% if event.description %}
      <hr>
      <p class="mb-0">{{ event.description }}</p>
    {% endif %}
  </div>
</div>


<div class="d-flex justify-content-between align-items-center mb-2">
  <h2 class="h5 mb-0">Available slots</h2>
  {% if not user.is_authenticated %}
    <div class="small text-secondary">To book a slot, <a href="/accounts/login/">login</a>.</div>
  {% endif %}
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Time</th>
          <th style="min-width: 240px;">Seats</th>
          <th class="text-end">Action</th>
        </tr>
      </thead>

      <tbody>
        {% for slot in slots %}
          <tr>
            <!-- TIME -->
            <td class="fw-semibold">{{ slot.start_datetime }}</td>

            <!-- SEATS (Progress Bar) -->
            <td style="min-width: 240px;">
              {% if slot.capacity %}
                <div class="d-flex justify-content-between small text-secondary mb-1">
                  <span>{{ slot.seats_left }} left</span>
                  <span>{{ slot.seats_taken }}/{{ slot.capacity }}</span>
                </div>

                <div class="progress" role="progressbar" aria-label="Seats">
                  <div
                    class="progress-bar {% if slot.is_full %}bg-danger{% else %}bg-success{% endif %}"
                    style="width: {{ slot.seats_percent }}%;">
                  </div>
                </div>
              {% else %}
                <span class="text-secondary">No capacity</span>
              {% endif %}
            </td>

            <!-- ACTION -->
            <td class="text-end">
              {% if user.is_authenticated %}
                {% if slot.id in user_booked_slot_ids %}
                  <form method="post" action="{% url 'cancel_slot' slot.id %}" class="d-inline">
                    {% csrf_token %}
                    <button class="btn btn-outline-danger btn-sm" type="submit">Cancel</button>
                  </form>
                {% else %}
                  {% if slot.is_full %}
                    <button class="btn btn-outline-secondary btn-sm" disabled>Full</button>
                  {% else %}
                    <form method="post" action="{% url 'book_slot' slot.id %}" class="d-inline">
                      {% csrf_token %}
                      <button class="btn btn-primary btn-sm" type="submit">Book</button>
                    </form>
                  {% endif %}
                {% endif %}
              {% else %}
                <a class="btn btn-outline-primary btn-sm" href="/accounts/login/">Login</a>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3" class="text-secondary">
              No slots yet. Add them in <a href="/admin/">Admin</a>.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
